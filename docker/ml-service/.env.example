# ML Service Configuration
# Copy this file to .env and customize as needed

# ============================================================================
# Application Configuration
# ============================================================================
SERVICE_NAME=ml-service
SERVICE_VERSION=1.0.0
VERICROP_MODE=prod  # dev (demo mode), prod (requires model)
ENVIRONMENT=production  # development, staging, production

# Server Configuration
HOST=0.0.0.0
PORT=8000
WORKERS=4  # Number of Uvicorn workers (set to CPU cores)
RELOAD=false  # Enable hot reload (dev only)

# ============================================================================
# Model Configuration
# ============================================================================
MODEL_PATH=/app/model/vericrop_quality_model.onnx
LABEL_MAP_PATH=/app/model/label_map.json
MODEL_INPUT_SIZE=224  # Image size expected by model (width x height)
MODEL_PRECISION=float32  # float32, float16 (for optimization)

# Model Performance
MODEL_BATCH_SIZE=1  # Inference batch size
MODEL_TIMEOUT=30  # seconds
ENABLE_MODEL_CACHE=true
CACHE_SIZE=100  # Number of predictions to cache

# ============================================================================
# Image Processing
# ============================================================================
MAX_IMAGE_SIZE=10485760  # 10MB in bytes
ALLOWED_EXTENSIONS=jpg,jpeg,png
IMAGE_QUALITY=95  # JPEG quality for saved images (0-100)
ENABLE_IMAGE_AUGMENTATION=false  # Enable for training data augmentation

# ============================================================================
# Prediction Configuration
# ============================================================================
CONFIDENCE_THRESHOLD=0.7  # Minimum confidence for predictions
QUALITY_SCORE_WEIGHTS_FRESH=1.0
QUALITY_SCORE_WEIGHTS_GOOD=0.8
QUALITY_SCORE_WEIGHTS_FAIR=0.5
QUALITY_SCORE_WEIGHTS_POOR=0.2

# ============================================================================
# Demo Mode Configuration
# ============================================================================
# Used when VERICROP_MODE=dev and model is not available
DEMO_MODE_ENABLED=true
DEMO_PREDICTION_DELAY=0.5  # seconds (simulates inference time)
DEMO_PREDICTION_QUALITY_RANGE_MIN=0.65
DEMO_PREDICTION_QUALITY_RANGE_MAX=0.95

# ============================================================================
# Logging Configuration
# ============================================================================
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FORMAT=json  # text or json
LOG_FILE=/app/logs/ml-service.log
LOG_ROTATION_SIZE=100MB
LOG_RETENTION_DAYS=30

# Structured Logging Fields
LOG_INCLUDE_TIMESTAMP=true
LOG_INCLUDE_REQUEST_ID=true
LOG_INCLUDE_USER_AGENT=true

# ============================================================================
# Security Configuration
# ============================================================================
# API Key Authentication (optional)
ENABLE_API_KEY_AUTH=false
API_KEY=<CHANGE-ME-generate-strong-api-key>

# CORS Configuration
CORS_ENABLED=true
CORS_ORIGINS=*  # Use specific origins in production: https://app.vericrop.com
CORS_METHODS=GET,POST,OPTIONS
CORS_ALLOW_CREDENTIALS=false

# Rate Limiting
ENABLE_RATE_LIMIT=true
RATE_LIMIT_REQUESTS=100  # requests per minute
RATE_LIMIT_WINDOW=60  # seconds

# ============================================================================
# Performance and Resource Management
# ============================================================================
# Memory Configuration
MAX_MEMORY_MB=4096  # Maximum memory usage
ENABLE_MEMORY_PROFILING=false

# Concurrency
MAX_CONCURRENT_REQUESTS=10
REQUEST_TIMEOUT=60  # seconds
WORKER_TIMEOUT=120  # seconds for Uvicorn workers

# Thread Configuration
ONNX_INTRA_OP_NUM_THREADS=4  # Threads for single operation
ONNX_INTER_OP_NUM_THREADS=2  # Threads for multiple operations

# ============================================================================
# Monitoring and Observability
# ============================================================================
# Health Check Configuration
HEALTH_CHECK_INTERVAL=30  # seconds
HEALTH_CHECK_TIMEOUT=5  # seconds

# Metrics Configuration
ENABLE_METRICS=true
METRICS_PORT=9090
METRICS_PATH=/metrics
METRICS_NAMESPACE=vericrop_ml

# Prometheus Metrics
PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus-multiproc
ENABLE_REQUEST_METRICS=true
ENABLE_INFERENCE_METRICS=true
ENABLE_SYSTEM_METRICS=true

# OpenTelemetry (optional)
ENABLE_TRACING=false
OTEL_SERVICE_NAME=vericrop-ml-service
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
OTEL_TRACES_SAMPLER=always_on

# ============================================================================
# Database Configuration (optional, for storing predictions)
# ============================================================================
ENABLE_PREDICTION_STORAGE=false
DB_HOST=localhost
DB_PORT=5432
DB_NAME=vericrop_ml
DB_USER=ml_service
DB_PASSWORD=<CHANGE-ME-db-password>
DB_POOL_SIZE=5

# ============================================================================
# External Services
# ============================================================================
# S3/Object Storage (for model artifacts)
ENABLE_S3_STORAGE=false
S3_BUCKET=vericrop-models
S3_REGION=us-east-1
S3_ACCESS_KEY=<CHANGE-ME-access-key>
S3_SECRET_KEY=<CHANGE-ME-secret-key>
S3_ENDPOINT_URL=https://s3.amazonaws.com  # For MinIO or custom endpoints

# Model Registry (MLflow, etc.)
ENABLE_MODEL_REGISTRY=false
MLFLOW_TRACKING_URI=http://localhost:5000
MLFLOW_EXPERIMENT_NAME=vericrop-quality-prediction

# ============================================================================
# Development and Testing
# ============================================================================
# Enable development features
DEBUG=false
TESTING=false
ENABLE_SWAGGER=true  # API documentation at /docs
ENABLE_REDOC=true  # Alternative API docs at /redoc

# Test Configuration
TEST_DATA_PATH=/app/tests/data
ENABLE_PROFILING=false
PROFILER_OUTPUT_DIR=/app/profiling

# ============================================================================
# Batch Processing (optional)
# ============================================================================
ENABLE_BATCH_API=false
MAX_BATCH_SIZE=100  # Maximum images per batch request
BATCH_TIMEOUT=300  # seconds

# ============================================================================
# Feature Flags
# ============================================================================
ENABLE_IMAGE_PREPROCESSING=true
ENABLE_RESULT_CACHING=true
ENABLE_ERROR_SCREENSHOTS=false  # Save problematic images for debugging
ERROR_SCREENSHOT_PATH=/app/errors

# Experimental Features
ENABLE_EXPERIMENTAL_FEATURES=false
ENABLE_GPU_ACCELERATION=false  # Requires ONNX GPU runtime
GPU_DEVICE_ID=0
